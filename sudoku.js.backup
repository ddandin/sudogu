class SudokuGame {
    constructor() {
        this.board = [];
        this.solution = [];
        this.selectedCell = null;
        this.difficulty = 'easy';
        this.mistakes = 0;
        this.timer = 0;
        this.timerInterval = null;
        this.completedDogs = [];
        this.breeds = ['Leka', 'Cosmo', 'Maya', 'Rio', 'George', 'Gofret', 'Ares', 'Tony', 'Hera'];
        this.breedImages = [
            'photos/Leka.png',
            'photos/Cosmo.png',
            'photos/Maya.png',
            'photos/Rio.png',
            'photos/George.png',
            'photos/Gofret.png',
            'photos/Ares.png',
            'photos/Tony.png',
            'photos/Hera.png'
        ];

        this.init();
    }

    init() {
        this.setupEventListeners();
        this.generateNewGame();
    }

    setupEventListeners() {
        document.querySelectorAll('.difficulty-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.difficulty-btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                this.difficulty = e.target.dataset.difficulty;
            });
        });

        document.querySelector('.new-game-btn').addEventListener('click', () => {
            this.generateNewGame();
        });

        document.querySelector('.check-btn').addEventListener('click', () => {
            this.checkSolution();
        });

        document.getElementById('show-timer').addEventListener('change', (e) => {
            const timerEl = document.querySelector('.timer');
            if (e.target.checked) {
                timerEl.style.display = 'flex';
            } else {
                timerEl.style.display = 'none';
            }
        });

        document.getElementById('show-mistakes').addEventListener('change', (e) => {
            const mistakesEl = document.querySelector('.mistakes');
            if (e.target.checked) {
                mistakesEl.style.display = 'flex';
            } else {
                mistakesEl.style.display = 'none';
            }
        });

        document.querySelectorAll('.dog-item').forEach(item => {
            item.addEventListener('click', (e) => {
                if (this.selectedCell) {
                    const dogItem = e.currentTarget;
                    const breedIndex = parseInt(dogItem.dataset.num);
                    this.placeNumber(breedIndex);
                }
            });
        });

        document.querySelector('.erase-btn-bottom')?.addEventListener('click', () => {
            if (this.selectedCell) {
                this.placeNumber(0);
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.key >= '1' && e.key <= '9') {
                if (this.selectedCell) {
                    this.placeNumber(parseInt(e.key));
                }
            } else if (e.key === 'Backspace' || e.key === 'Delete' || e.key === '0') {
                if (this.selectedCell) {
                    this.placeNumber(0);
                }
            }
        });
    }

    generateSolvedBoard() {
        this.solution = Array(9).fill(null).map(() => Array(9).fill(0));
        this.fillBoard(this.solution);
        return this.solution;
    }

    fillBoard(board) {
        const numbers = [1, 2, 3, 4, 5, 6, 7, 8, 9];

        for (let row = 0; row < 9; row++) {
            for (let col = 0; col < 9; col++) {
                if (board[row][col] === 0) {
                    const shuffled = this.shuffle([...numbers]);

                    for (let num of shuffled) {
                        if (this.isValid(board, row, col, num)) {
                            board[row][col] = num;

                            if (this.fillBoard(board)) {
                                return true;
                            }

                            board[row][col] = 0;
                        }
                    }
                    return false;
                }
            }
        }
        return true;
    }

    isValid(board, row, col, num) {
        for (let x = 0; x < 9; x++) {
            if (board[row][x] === num || board[x][col] === num) {
                return false;
            }
        }

        const startRow = Math.floor(row / 3) * 3;
        const startCol = Math.floor(col / 3) * 3;

        for (let i = 0; i < 3; i++) {
            for (let j = 0; j < 3; j++) {
                if (board[startRow + i][startCol + j] === num) {
                    return false;
                }
            }
        }

        return true;
    }

    shuffle(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    generatePuzzle() {
        this.generateSolvedBoard();
        this.board = this.solution.map(row => [...row]);

        const cellsToRemove = {
            'easy': 30,
            'medium': 40,
            'hard': 50
        };

        const toRemove = cellsToRemove[this.difficulty];
        const cells = [];

        for (let row = 0; row < 9; row++) {
            for (let col = 0; col < 9; col++) {
                cells.push({row, col});
            }
        }

        this.shuffle(cells);

        let removed = 0;
        for (let cell of cells) {
            if (removed >= toRemove) break;

            const {row, col} = cell;
            const backup = this.board[row][col];
            this.board[row][col] = 0;

            if (this.countSolutions(this.board.map(r => [...r])) === 1) {
                removed++;
            } else {
                this.board[row][col] = backup;
            }
        }
    }

    countSolutions(board, limit = 2) {
        let count = 0;

        const findEmpty = () => {
            for (let row = 0; row < 9; row++) {
                for (let col = 0; col < 9; col++) {
                    if (board[row][col] === 0) {
                        return {row, col};
                    }
                }
            }
            return null;
        };

        const solve = () => {
            if (count >= limit) return;

            const empty = findEmpty();
            if (!empty) {
                count++;
                return;
            }

            const {row, col} = empty;
            const numbers = this.shuffle([1, 2, 3, 4, 5, 6, 7, 8, 9]);

            for (let num of numbers) {
                if (this.isValid(board, row, col, num)) {
                    board[row][col] = num;
                    solve();
                    board[row][col] = 0;

                    if (count >= limit) return;
                }
            }
        };

        solve();
        return count;
    }

    generateNewGame() {
        this.mistakes = 0;
        this.timer = 0;
        this.selectedCell = null;
        this.completedDogs = [];

        if (this.timerInterval) {
            clearInterval(this.timerInterval);
        }

        this.generatePuzzle();
        this.renderBoard();
        this.updateMistakes();
        this.startTimer();
        this.showMessage('');
    }

    renderBoard() {
        const boardElement = document.getElementById('sudoku-board');
        boardElement.innerHTML = '';

        for (let row = 0; row < 9; row++) {
            for (let col = 0; col < 9; col++) {
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.dataset.row = row;
                cell.dataset.col = col;

                if ((Math.floor(row / 3) + Math.floor(col / 3)) % 2 === 0) {
                    cell.classList.add('alt-block');
                }

                if (this.board[row][col] !== 0) {
                    const img = document.createElement('img');
                    img.src = this.breedImages[this.board[row][col] - 1];
                    img.alt = this.breeds[this.board[row][col] - 1];
                    img.className = 'cell-img';
                    cell.appendChild(img);
                    cell.classList.add('given');
                } else {
                    cell.innerHTML = '';
                }

                cell.addEventListener('click', () => this.selectCell(cell));

                boardElement.appendChild(cell);
            }
        }
    }

    selectCell(cell) {
        if (cell.classList.contains('given')) {
            return;
        }

        document.querySelectorAll('.cell').forEach(c => c.classList.remove('selected'));
        cell.classList.add('selected');
        this.selectedCell = cell;
    }

    placeNumber(num) {
        if (!this.selectedCell || this.selectedCell.classList.contains('given')) {
            return;
        }

        const row = parseInt(this.selectedCell.dataset.row);
        const col = parseInt(this.selectedCell.dataset.col);

        if (num === 0) {
            this.board[row][col] = 0;
            this.selectedCell.innerHTML = '';
            this.selectedCell.classList.remove('error');
            this.selectedCell.classList.remove('valid');
            this.updateCompletedDogs();
        } else {
            this.board[row][col] = 0;

            if (this.isValid(this.board, row, col, num)) {
                this.board[row][col] = num;
                const img = document.createElement('img');
                img.src = this.breedImages[num - 1];
                img.alt = this.breeds[num - 1];
                img.className = 'cell-img';
                this.selectedCell.innerHTML = '';
                this.selectedCell.appendChild(img);
                this.selectedCell.classList.remove('error');
                this.selectedCell.classList.add('valid');

                this.updateCompletedDogs();

                if (this.isBoardComplete() && this.isBoardFullyValid()) {
                    this.endGame(true);
                }
            } else {
                this.board[row][col] = num;
                const img = document.createElement('img');
                img.src = this.breedImages[num - 1];
                img.alt = this.breeds[num - 1];
                img.className = 'cell-img';
                this.selectedCell.innerHTML = '';
                this.selectedCell.appendChild(img);
                this.selectedCell.classList.add('error');
                this.selectedCell.classList.remove('valid');
                this.mistakes++;
                this.updateMistakes();
                this.updateCompletedDogs();
            }
        }
    }

    updateCompletedDogs() {
        const completed = [];
        const previouslyCompleted = this.completedDogs || [];

        for (let num = 1; num <= 9; num++) {
            let count = 0;
            for (let row = 0; row < 9; row++) {
                for (let col = 0; col < 9; col++) {
                    if (this.board[row][col] === num) {
                        count++;
                    }
                }
            }

            if (count === 9) {
                completed.push(num);
            }
        }

        document.querySelectorAll('.dog-item').forEach(item => {
            const dogNum = parseInt(item.dataset.num);
            if (completed.includes(dogNum)) {
                item.classList.add('completed');
            } else {
                item.classList.remove('completed');
            }
        });

        document.querySelectorAll('.dog-name-item').forEach(item => {
            const dogNum = parseInt(item.dataset.num);
            if (completed.includes(dogNum)) {
                item.classList.add('completed');
            } else {
                item.classList.remove('completed');
            }
        });

        const newlyCompleted = completed.filter(num => !previouslyCompleted.includes(num));
        if (newlyCompleted.length > 0) {
            newlyCompleted.forEach(num => {
                this.showAchievement(this.breeds[num - 1]);
            });
        }

        this.completedDogs = completed;
    }

    showAchievement(dogName) {
        const overlay = document.getElementById('achievement-overlay');
        const text = overlay.querySelector('.achievement-text');
        const confettiContainer = overlay.querySelector('.confetti-container');

        text.textContent = `All ${dogName} placed!`;

        confettiContainer.innerHTML = '';

        const dogIndex = this.breeds.indexOf(dogName);
        const dogImage = this.breedImages[dogIndex];

        for (let i = 0; i < 50; i++) {
            const confetti = document.createElement('div');
            confetti.className = 'confetti';
            confetti.style.left = Math.random() * 100 + '%';
            confetti.style.backgroundImage = `url('${dogImage}')`;
            confetti.style.animationDelay = Math.random() * 1.5 + 's';
            confetti.style.animationDuration = (Math.random() * 3 + 4) + 's';
            const randomSize = 35 + Math.random() * 40;
            confetti.style.width = randomSize + 'px';
            confetti.style.height = randomSize + 'px';
            confettiContainer.appendChild(confetti);
        }

        overlay.classList.add('show');

        setTimeout(() => {
            overlay.classList.remove('show');
        }, 5000);
    }

    isBoardComplete() {
        for (let row = 0; row < 9; row++) {
            for (let col = 0; col < 9; col++) {
                if (this.board[row][col] === 0) {
                    return false;
                }
            }
        }
        return true;
    }

    isBoardFullyValid() {
        for (let row = 0; row < 9; row++) {
            for (let col = 0; col < 9; col++) {
                const num = this.board[row][col];
                if (num === 0) continue;

                this.board[row][col] = 0;
                if (!this.isValid(this.board, row, col, num)) {
                    this.board[row][col] = num;
                    return false;
                }
                this.board[row][col] = num;
            }
        }
        return true;
    }

    checkSolution() {
        let hasErrors = false;

        document.querySelectorAll('.cell').forEach(cell => {
            if (!cell.classList.contains('given')) {
                const row = parseInt(cell.dataset.row);
                const col = parseInt(cell.dataset.col);
                const num = this.board[row][col];

                if (num !== 0) {
                    this.board[row][col] = 0;
                    const isValidMove = this.isValid(this.board, row, col, num);
                    this.board[row][col] = num;

                    if (!isValidMove) {
                        cell.classList.add('error');
                        cell.classList.remove('valid');
                        hasErrors = true;
                    } else {
                        cell.classList.remove('error');
                        cell.classList.add('valid');
                    }
                }
            }
        });

        if (!hasErrors && this.isBoardComplete()) {
            this.endGame(true);
        } else if (!hasErrors) {
            this.showMessage('Keep going! No errors so far.', 'success');
        } else {
            this.showMessage('There are errors in your solution.', 'error');
        }
    }

    updateMistakes() {
        document.querySelector('.mistakes-count').textContent = this.mistakes;
    }

    startTimer() {
        document.querySelector('.time-display').textContent = '00:00';

        this.timerInterval = setInterval(() => {
            this.timer++;
            const minutes = Math.floor(this.timer / 60).toString().padStart(2, '0');
            const seconds = (this.timer % 60).toString().padStart(2, '0');
            document.querySelector('.time-display').textContent = `${minutes}:${seconds}`;
        }, 1000);
    }

    endGame(won) {
        clearInterval(this.timerInterval);

        if (won) {
            const minutes = Math.floor(this.timer / 60);
            const seconds = this.timer % 60;
            this.showMessage(`Congratulations! You solved it in ${minutes}m ${seconds}s with ${this.mistakes} mistakes.`, 'success');
        }
    }

    showMessage(text, type = '') {
        const messageEl = document.getElementById('message');
        messageEl.textContent = text;
        messageEl.className = 'message';

        if (type) {
            messageEl.classList.add(type);
        }

        if (text) {
            messageEl.classList.add('show');
        } else {
            messageEl.classList.remove('show');
        }
    }
}

document.addEventListener('DOMContentLoaded', () => {
    new SudokuGame();
});
